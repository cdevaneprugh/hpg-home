<?xml version="1.0"?>
<config_batch version="2.1">

  <batch_system type="slurm" >
    <batch_query per_job_arg="-j">squeue</batch_query>
    <batch_submit>sbatch</batch_submit>
    <batch_cancel>scancel</batch_cancel>
    <batch_directive>#SBATCH</batch_directive>
    <jobid_pattern>(\d+)$</jobid_pattern>
    <depend_string>--dependency=afterok:jobid</depend_string>
    <depend_allow_string>--dependency=afterany:jobid</depend_allow_string>
    <depend_separator>,</depend_separator>
    <walltime_format>%H:%M:%S</walltime_format>
    <batch_mail_flag>--mail-user</batch_mail_flag>
    <batch_mail_type_flag>--mail-type</batch_mail_type_flag>
    <batch_mail_type>NONE, ALL, BEGIN, END, FAIL</batch_mail_type>
    <submit_args>
      <arg flag="--time" name="$JOB_WALLCLOCK_TIME"/>
      <arg flag="-q" name="$JOB_QUEUE"/>
      <arg flag="--export=ALL"/>
    </submit_args>
    <directives>
      <directive> --job-name={{ job_id }}</directive>
      <directive> --nodes={{ num_nodes }}</directive>
      <directive> --ntasks-per-node={{ tasks_per_node }}</directive>
      <directive> --output={{ job_id }}.%j </directive>
    </directives>
  </batch_system>

  <batch_system MACH="hipergator" type="slurm">
    <directives>
      <directive>--partition=hpg-default</directive>
      <directive>--mail-type=END,FAIL</directive>
      <directive>--mail-user=cdevaneprugh@ufl.edu</directive>
    </directives>
    <queues>
      <queue jobmin="1" jobmax="20" default="true">gerber</queue><!--Default QOS-->
      <queue jobmin="1" jobmax="128">gerber-b</queue><!--Burst QOS-->
    </queues>
  </batch_system>

  <batch_jobs>
    <!-- order matters, with no-batch jobs will be run in the order listed here -->
    <job name="case.run">
      <template>template.case.run</template>
      <prereq>$BUILD_COMPLETE and not $TEST</prereq>
    </job>
    <job name="case.run.sh">
      <template>template.case.run.sh</template>
      <prereq>False</prereq>
    </job>
   <job name="case.test">
      <template>template.case.test</template>
      <prereq>$BUILD_COMPLETE and $TEST</prereq>
    </job>
    <job name="case.st_archive">
      <template>template.st_archive</template>
      <task_count>1</task_count>
      <walltime>0:20:00</walltime>
      <!-- If DOUT_S is true and case.run (or case.test) exits successfully then run st_archive-->
      <dependency>case.run case.test</dependency>
      <prereq>$DOUT_S</prereq>
    </job>
  </batch_jobs>

</config_batch>
